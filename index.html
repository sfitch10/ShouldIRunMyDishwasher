<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Should I Run My Dishwasher?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for better visual appeal */
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .time-slot {
            transition: all 0.3s ease-in-out;
        }
        .current-hour-indicator {
            box-shadow: 0 0 15px 3px rgba(255, 255, 255, 0.9);
        }
        .pulse-live {
            animation: pulse-live-anim 2s infinite;
        }
        @keyframes pulse-live-anim {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: .7;
            }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Should I Run My Dishwasher?</h1>
            <p class="text-gray-500 mt-2">Find the cheapest time to use your appliances based on regional Time-of-Use (TOU) rates.</p>
        </div>

        <!-- Location Info -->
        <div id="location-container" class="text-center mb-4">
            <p id="location-info" class="text-md text-gray-600 font-medium">Getting your location...</p>
            <!-- Manual Selection Form (Initially Hidden) -->
            <div id="manual-location-form" class="hidden mt-4 p-4 bg-gray-100 rounded-lg">
                <p id="manual-location-prompt" class="mb-2 text-gray-700">Could not get location. Please enter your Zip Code:</p>
                <input type="text" id="zip-code-input" inputmode="numeric" pattern="[0-9]*" maxlength="5" class="w-full max-w-xs mx-auto p-2 border border-gray-300 rounded-md shadow-sm text-center" placeholder="e.g., 90210">
                <button id="manual-submit-btn" class="mt-3 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Get Rates
                </button>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="loading-state" class="flex justify-center items-center p-8">
            <div class="spinner"></div>
        </div>

        <!-- Main Content (Initially Hidden) -->
        <div id="main-content" class="hidden">
            <!-- Live Grid Status Card -->
            <div id="live-status-card" class="card p-4 text-center mb-8 hidden">
                 <div class="flex items-center justify-center">
                    <span id="live-dot" class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                    <h2 id="live-status-title" class="text-lg font-bold text-gray-800">Live Grid Status</h2>
                </div>
                <p id="live-status-text" class="text-gray-600 mt-2">Fetching live data...</p>
            </div>

            <!-- Main Status Card -->
            <div id="status-card" class="card p-6 md:p-8 text-center mb-8">
                <p class="text-sm font-medium text-gray-500">Current Time</p>
                <p id="current-time" class="text-4xl font-bold text-gray-900 my-2">--:--:-- --</p>
                
                <div id="status-indicator" class="inline-flex items-center justify-center px-4 py-2 mt-2 mb-4 rounded-full font-semibold text-lg">
                    <span id="status-icon" class="mr-2"></span>
                    <span id="status-text">Loading...</span>
                </div>

                <p id="recommendation" class="text-lg text-gray-700 h-12">Calculating recommendation...</p>
                <p id="countdown" class="text-md font-medium text-gray-500 mt-2 h-6"></p>
            </div>

            <!-- 24-Hour Schedule Visualization -->
            <div id="schedule-visualization">
                <h2 class="text-xl font-bold text-gray-800 text-center mb-4">Today's Schedule</h2>
                <div class="grid grid-cols-12 md:grid-cols-24 gap-1 text-xs text-center">
                    <!-- Hour slots will be generated by JavaScript -->
                </div>
                 <div class="flex justify-center items-center space-x-4 mt-4 text-sm">
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-400 mr-2"></span>Peak</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-400 mr-2"></span>Mid-Peak</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-400 mr-2"></span>Off-Peak</div>
                </div>
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="text-center mt-8">
            <p class="text-xs text-gray-400">Disclaimer: This tool uses location data to provide estimates based on common regional TOU rate structures. Live data is provided for states covered by CAISO, ERCOT, ISO-NE, MISO, NYISO, PJM, and SPP where available. Your actual rates and times may vary. Always check with your local utility provider for the most accurate information.</p>
        </div>

    </main>

    <script>
        // --- CONFIGURATION ---
        const RATE_PERIODS = {
            PEAK: { name: 'Peak', message: "Running the dishwasher now is like buying designer water. Let's wait.", icon: 'ï¿½', bgColor: 'bg-red-100', textColor: 'text-red-800', barColor: 'bg-red-400' },
            MID_PEAK: { name: 'Mid-Peak', message: 'Patience, young grasshopper. Cheaper times are just around the corner.', icon: 'ðŸŸ¡', bgColor: 'bg-yellow-100', textColor: 'text-yellow-800', barColor: 'bg-yellow-400' },
            OFF_PEAK: { name: 'Off-Peak', message: 'The stars have aligned and the price is right! Let the clean times roll.', icon: 'ðŸŸ¢', bgColor: 'bg-green-100', textColor: 'text-green-800', barColor: 'bg-green-400' },
            SUPER_PEAK: { name: 'Grid Stress', message: "The power grid is officially overwhelmed. Doing the dishes now would be a villain origin story.", icon: 'ðŸš¨', bgColor: 'bg-red-200', textColor: 'text-red-900', barColor: 'bg-red-600' }
        };

        // --- REGIONAL SCHEDULE TEMPLATES ---
        const WEEKEND_OFF_PEAK = { weekend: [{ start: 0, end: 24, period: 'OFF_PEAK' }] };
        const MISO_SCHEDULE = { weekday: [{ start: 0, end: 14, period: 'OFF_PEAK' },{ start: 14, end: 19, period: 'PEAK' },{ start: 19, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK };
        const PJM_SCHEDULE = { weekday: [{ start: 0, end: 15, period: 'OFF_PEAK' },{ start: 15, end: 19, period: 'PEAK' },{ start: 19, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK };
        const SOUTHEAST_SCHEDULE = { weekday: [{ start: 0, end: 13, period: 'OFF_PEAK' },{ start: 13, end: 19, period: 'PEAK' },{ start: 19, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK };
        const NORTHWEST_SCHEDULE = { weekday: [{ start: 0, end: 7, period: 'OFF_PEAK' },{ start: 7, end: 10, period: 'PEAK' },{ start: 10, end: 17, period: 'OFF_PEAK' },{ start: 17, end: 20, period: 'PEAK' },{ start: 20, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK };
        const SOUTHWEST_SCHEDULE = { weekday: [{ start: 0, end: 15, period: 'OFF_PEAK' },{ start: 15, end: 20, period: 'PEAK' },{ start: 20, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK };

        // --- STATE-BY-STATE SCHEDULES ---
        const SCHEDULES = {
            'AL': { name: "Alabama", gridOperator: null, ...SOUTHEAST_SCHEDULE },
            'AK': { name: "Alaska", gridOperator: null, weekday: [{ start: 0, end: 17, period: 'OFF_PEAK' },{ start: 17, end: 21, period: 'PEAK' },{ start: 21, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'AZ': { name: "Arizona", gridOperator: null, ...SOUTHWEST_SCHEDULE },
            'AR': { name: "Arkansas", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'CA': { name: "California", gridOperator: 'CAISO', weekday: [{ start: 0, end: 16, period: 'OFF_PEAK' },{ start: 16, end: 21, period: 'PEAK' },{ start: 21, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'CO': { name: "Colorado", gridOperator: null, ...SOUTHWEST_SCHEDULE },
            'CT': { name: "Connecticut", gridOperator: 'ISONE', weekday: [{ start: 0, end: 18, period: 'OFF_PEAK' },{ start: 18, end: 21, period: 'PEAK' },{ start: 21, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'DE': { name: "Delaware", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'FL': { name: "Florida", gridOperator: null, ...SOUTHEAST_SCHEDULE },
            'GA': { name: "Georgia", gridOperator: null, ...SOUTHEAST_SCHEDULE },
            'HI': { name: "Hawaii", gridOperator: null, weekday: [{ start: 0, end: 9, period: 'OFF_PEAK' },{ start: 9, end: 17, period: 'MID_PEAK' },{ start: 17, end: 21, period: 'PEAK' },{ start: 21, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'ID': { name: "Idaho", gridOperator: null, ...NORTHWEST_SCHEDULE },
            'IL': { name: "Illinois", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'IN': { name: "Indiana", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'IA': { name: "Iowa", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'KS': { name: "Kansas", gridOperator: 'SPP', weekday: [{ start: 0, end: 15, period: 'OFF_PEAK' },{ start: 15, end: 19, period: 'PEAK' },{ start: 19, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'KY': { name: "Kentucky", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'LA': { name: "Louisiana", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'ME': { name: "Maine", gridOperator: 'ISONE', weekday: [{ start: 0, end: 16, period: 'OFF_PEAK' },{ start: 16, end: 20, period: 'PEAK' },{ start: 20, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'MD': { name: "Maryland", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'MA': { name: "Massachusetts", gridOperator: 'ISONE', weekday: [{ start: 0, end: 17, period: 'OFF_PEAK' },{ start: 17, end: 20, period: 'PEAK' },{ start: 20, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'MI': { name: "Michigan", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'MN': { name: "Minnesota", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'MS': { name: "Mississippi", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'MO': { name: "Missouri", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'MT': { name: "Montana", gridOperator: null, ...NORTHWEST_SCHEDULE },
            'NE': { name: "Nebraska", gridOperator: 'SPP', weekday: [{ start: 0, end: 14, period: 'OFF_PEAK' },{ start: 14, end: 19, period: 'PEAK' },{ start: 19, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'NV': { name: "Nevada", gridOperator: null, ...SOUTHWEST_SCHEDULE },
            'NH': { name: "New Hampshire", gridOperator: 'ISONE', weekday: [{ start: 0, end: 17, period: 'OFF_PEAK' },{ start: 17, end: 20, period: 'PEAK' },{ start: 20, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'NJ': { name: "New Jersey", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'NM': { name: "New Mexico", gridOperator: null, ...SOUTHWEST_SCHEDULE },
            'NY': { name: "New York", gridOperator: 'NYISO', weekday: [{ start: 0, end: 8, period: 'OFF_PEAK' },{ start: 8, end: 12, period: 'MID_PEAK' },{ start: 12, end: 18, period: 'PEAK' },{ start: 18, end: 22, period: 'MID_PEAK'},{ start: 22, end: 24, period: 'OFF_PEAK'}], ...WEEKEND_OFF_PEAK },
            'NC': { name: "North Carolina", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'ND': { name: "North Dakota", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'OH': { name: "Ohio", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'OK': { name: "Oklahoma", gridOperator: 'SPP', weekday: [{ start: 0, end: 13, period: 'OFF_PEAK' },{ start: 13, end: 19, period: 'PEAK' },{ start: 19, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'OR': { name: "Oregon", gridOperator: null, ...NORTHWEST_SCHEDULE },
            'PA': { name: "Pennsylvania", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'RI': { name: "Rhode Island", gridOperator: 'ISONE', weekday: [{ start: 0, end: 17, period: 'OFF_PEAK' },{ start: 17, end: 20, period: 'PEAK' },{ start: 20, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'SC': { name: "South Carolina", gridOperator: null, ...SOUTHEAST_SCHEDULE },
            'SD': { name: "South Dakota", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'TN': { name: "Tennessee", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'TX': { name: "Texas", gridOperator: 'ERCOT', weekday: [{ start: 0, end: 15, period: 'OFF_PEAK' },{ start: 15, end: 19, period: 'PEAK' },{ start: 19, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'UT': { name: "Utah", gridOperator: null, ...SOUTHWEST_SCHEDULE },
            'VT': { name: "Vermont", gridOperator: 'ISONE', weekday: [{ start: 0, end: 16, period: 'OFF_PEAK' },{ start: 16, end: 19, period: 'PEAK' },{ start: 19, end: 24, period: 'OFF_PEAK' }], ...WEEKEND_OFF_PEAK },
            'VA': { name: "Virginia", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'WA': { name: "Washington", gridOperator: null, ...NORTHWEST_SCHEDULE },
            'WV': { name: "West Virginia", gridOperator: 'PJM', ...PJM_SCHEDULE },
            'WI': { name: "Wisconsin", gridOperator: 'MISO', ...MISO_SCHEDULE },
            'WY': { name: "Wyoming", gridOperator: null, ...NORTHWEST_SCHEDULE },
            'DEFAULT': { name: "Default", gridOperator: null, weekday: [{ start: 0, end: 7, period: 'OFF_PEAK' },{ start: 7, end: 16, period: 'MID_PEAK' },{ start: 16, end: 21, period: 'PEAK' },{ start: 21, end: 24, period: 'MID_PEAK' }], ...WEEKEND_OFF_PEAK }
        };

        // --- REAL-TIME GRID OPERATOR CONFIGURATION ---
        const GRID_OPERATORS = {
            'CAISO': { name: "CAISO", apiUrl: 'https://api.allorigins.win/get?url=https%3A//www.caiso.com/outlook/systemstatus/serv/supply.json', demandThresholdMw: 35000, parser: r => parseInt(JSON.parse(r.contents).data.slice(-1)[0].SystemDemand, 10) },
            'ERCOT': { name: "ERCOT", apiUrl: 'https://api.allorigins.win/get?url=https%3A//www.ercot.com/api/1/services/read/dash/actual_loads_for_display.json', demandThresholdMw: 70000, parser: r => parseInt(JSON.parse(r.contents).current_load, 10) },
            'NYISO': { name: "NYISO", apiUrl: 'https://api.allorigins.win/get?url=https%3A//www.nyiso.com/mis/public/realtime/load.csv', demandThresholdMw: 28000, parser: r => parseInt(r.contents.split('\n').slice(-2, -1)[0].split(',')[1], 10) },
            'MISO': { name: "MISO", apiUrl: 'https://api.allorigins.win/get?url=https%3A//www.misoenergy.org/ria/RealTimeLoad.json', demandThresholdMw: 100000, parser: r => parseInt(JSON.parse(r.contents).LoadInfo.find(i => i.RefID === 'MISO').Load, 10) },
            'PJM': { name: "PJM", apiUrl: 'https://api.allorigins.win/get?url=https%3A//api.pjm.com/api/v1/rt_hrl_load', demandThresholdMw: 140000, parser: r => parseInt(JSON.parse(r.contents)[0].load_mw, 10) },
            'ISONE': { name: "ISO-NE", apiUrl: 'https://api.allorigins.win/get?url=https%3A//www.iso-ne.com/ws/wsclient', demandThresholdMw: 25000, parser: r => parseInt(JSON.parse(r.contents).reports.find(rep => rep.id === 'realtimeload').data.find(d => d.id === 'load').value, 10) },
            'SPP': { name: "SPP", apiUrl: 'https://api.allorigins.win/get?url=https%3A//www.spp.org/api/load-forecast', demandThresholdMw: 50000, parser: r => parseInt(JSON.parse(r.contents).ActualLoad, 10) },
        };
        
        // --- GLOBAL STATE ---
        let activeSchedule = null;
        let updateInterval = null;
        let gridStatus = { live: false, demand: null, updated: null };

        // --- DOM ELEMENTS ---
        const locationInfoEl = document.getElementById('location-info');
        const manualLocationFormEl = document.getElementById('manual-location-form');
        const manualLocationPromptEl = document.getElementById('manual-location-prompt');
        const zipCodeInputEl = document.getElementById('zip-code-input');
        const manualSubmitBtn = document.getElementById('manual-submit-btn');
        const mainContentEl = document.getElementById('main-content');
        const loadingStateEl = document.getElementById('loading-state');

        const liveStatusCardEl = document.getElementById('live-status-card');
        const liveStatusTitleEl = document.getElementById('live-status-title');
        const liveStatusTextEl = document.getElementById('live-status-text');
        const liveDotEl = document.getElementById('live-dot');
        const currentTimeEl = document.getElementById('current-time');
        const statusIndicatorEl = document.getElementById('status-indicator');
        const statusIconEl = document.getElementById('status-icon');
        const statusTextEl = document.getElementById('status-text');
        const recommendationEl = document.getElementById('recommendation');
        const countdownEl = document.getElementById('countdown');
        const scheduleContainer = document.querySelector('#schedule-visualization .grid');

        // --- CORE LOGIC ---
        function getPeriodForHour(day, hour, schedule) {
            const isWeekend = (day === 0 || day === 6);
            const daySchedule = isWeekend ? schedule.weekend : schedule.weekday;
            for (const slot of daySchedule) {
                if (hour >= slot.start && hour < slot.end) {
                    return { period: RATE_PERIODS[slot.period], endHour: slot.end };
                }
            }
            return { period: RATE_PERIODS.OFF_PEAK, endHour: 24 }; // Fallback
        }

        function getCurrentState(now, schedule) {
            const hour = now.getHours();
            const day = now.getDay();
            const operator = schedule.gridOperator ? GRID_OPERATORS[schedule.gridOperator] : null;
            
            if (operator && gridStatus.live && gridStatus.demand > operator.demandThresholdMw) {
                return { period: RATE_PERIODS.SUPER_PEAK, endHour: hour + 1 };
            }

            return getPeriodForHour(day, hour, schedule);
        }

        function getNextOffPeakTime(now, schedule) {
            let checkDate = new Date(now);
            checkDate.setHours(now.getHours() + 1, 0, 0, 0);
            const operator = schedule.gridOperator ? GRID_OPERATORS[schedule.gridOperator] : null;

            for (let i = 0; i < 48; i++) { // Check up to 2 days
                const day = checkDate.getDay();
                const hour = checkDate.getHours();
                const state = getPeriodForHour(day, hour, schedule);
                if (state && state.period.name === 'Off-Peak') {
                     // If grid is stressed, keep looking for the next non-stressed off-peak time
                    if (!(operator && gridStatus.live && gridStatus.demand > operator.demandThresholdMw)) {
                         return checkDate;
                    }
                }
                checkDate.setHours(checkDate.getHours() + 1);
            }
            return new Date(now); // Fallback
        }

        function formatTimeRemaining(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (hours === 0 && minutes < 30) parts.push(`${seconds}s`);
            return `in ${parts.join(' ')}`;
        }

        function updateUI() {
            if (!activeSchedule) return;
            const operator = activeSchedule.gridOperator ? GRID_OPERATORS[activeSchedule.gridOperator] : null;

            if (operator && gridStatus.live && gridStatus.demand) {
                liveDotEl.classList.remove('bg-gray-400');
                liveDotEl.classList.add('bg-green-500', 'pulse-live');
                const demandGW = (gridStatus.demand / 1000).toFixed(2);
                liveStatusTextEl.innerHTML = `Current Demand: <span class="font-bold text-gray-900">${demandGW} GW</span>. <br><span class="text-xs">Updated: ${gridStatus.updated.toLocaleTimeString()}</span>`;
            } else if (operator && gridStatus.live === 'error') {
                 liveDotEl.classList.remove('bg-green-500', 'pulse-live');
                 liveDotEl.classList.add('bg-red-500');
                 liveStatusTextEl.textContent = 'Live data unavailable. Using standard schedule.';
            }

            const now = new Date();
            const { period, endHour } = getCurrentState(now, activeSchedule);

            currentTimeEl.textContent = now.toLocaleTimeString('en-US');
            statusIndicatorEl.className = `inline-flex items-center justify-center px-4 py-2 mt-2 mb-4 rounded-full font-semibold text-lg ${period.bgColor} ${period.textColor}`;
            statusIconEl.textContent = period.icon;
            statusTextEl.textContent = period.name;
            recommendationEl.textContent = period.message;

            if (period.name === 'Grid Stress') {
                countdownEl.textContent = 'Re-checking grid status shortly...';
            } else if (period.name !== 'Off-Peak') {
                const nextOffPeak = getNextOffPeakTime(now, activeSchedule);
                const secondsRemaining = (nextOffPeak - now) / 1000;
                countdownEl.textContent = `Next cheap window ${formatTimeRemaining(secondsRemaining)}`;
            } else {
                const endOfWindow = new Date(now);
                endOfWindow.setHours(endHour, 0, 0, 0);
                 if (endOfWindow < now) { endOfWindow.setDate(endOfWindow.getDate() + 1); }
                const secondsRemaining = (endOfWindow - now) / 1000;
                countdownEl.textContent = `Cheap window ends ${formatTimeRemaining(secondsRemaining)}`;
            }
            
            const currentHour = now.getHours();
            document.querySelectorAll('.time-slot').forEach((slot) => {
                const hour = parseInt(slot.dataset.hour, 10);
                slot.classList.toggle('current-hour-indicator', hour === currentHour);
                slot.classList.toggle('scale-110', hour === currentHour);
                slot.classList.toggle('font-bold', hour === currentHour);
            });
        }
        
        function drawSchedule() {
            if (!activeSchedule) return;
            scheduleContainer.innerHTML = '';
            const now = new Date();
            const day = now.getDay();
            for (let hour = 0; hour < 24; hour++) {
                const { period } = getPeriodForHour(day, hour, activeSchedule);
                const hourEl = document.createElement('div');
                const displayHour = hour === 0 ? '12a' : (hour < 12 ? `${hour}a` : (hour === 12 ? '12p' : `${hour-12}p`));
                let hourLabelClass = (hour % 2 === 0) ? 'block' : 'hidden md:block';
                hourEl.className = `time-slot p-2 rounded-lg text-white ${period.barColor}`;
                hourEl.innerHTML = `<span class="${hourLabelClass}">${displayHour}</span>`;
                hourEl.dataset.hour = hour;
                scheduleContainer.appendChild(hourEl);
            }
        }

        async function fetchRealTimeData() {
            if (!activeSchedule || !activeSchedule.gridOperator) {
                gridStatus.live = false;
                liveStatusCardEl.classList.add('hidden');
                return;
            }
            const operator = GRID_OPERATORS[activeSchedule.gridOperator];

            liveStatusCardEl.classList.remove('hidden');
            liveStatusTitleEl.textContent = `Live ${operator.name} Grid Status`;

            try {
                const response = await fetch(operator.apiUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                gridStatus.live = true;
                gridStatus.demand = operator.parser(data);
                gridStatus.updated = new Date();

            } catch (error) {
                console.error(`Error fetching real-time data for ${operator.name}:`, error);
                gridStatus.live = 'error';
                gridStatus.demand = null;
            }
            updateUI();
        }

        function initApp(schedule) {
            activeSchedule = schedule;

            // Hide loading state and show main content
            loadingStateEl.classList.add('hidden');
            mainContentEl.classList.remove('hidden');
            
            locationInfoEl.textContent = `ðŸ“ Showing rates for: ${schedule.name}`;
            manualLocationFormEl.classList.add('hidden');

            drawSchedule();
            updateUI();
            
            if(updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(updateUI, 1000);

            fetchRealTimeData();
            setInterval(fetchRealTimeData, 300000); // 5 minutes
        }

        async function handleManualZipSubmit() {
            const zipCode = zipCodeInputEl.value.trim();
            if (!/^\d{5}$/.test(zipCode)) {
                manualLocationPromptEl.textContent = "Please enter a valid 5-digit zip code.";
                manualLocationPromptEl.classList.add('text-red-600');
                return;
            }
            
            manualLocationPromptEl.textContent = "Looking up zip code...";
            manualLocationPromptEl.classList.remove('text-red-600');

            try {
                const response = await fetch(`https://api.zippopotam.us/us/${zipCode}`);
                if (!response.ok) throw new Error('Invalid zip code');
                const data = await response.json();
                
                const stateAbbr = data.places[0]['state abbreviation'];
                const scheduleKey = stateAbbr && SCHEDULES[stateAbbr] ? stateAbbr : 'DEFAULT';
                initApp(SCHEDULES[scheduleKey]);

            } catch (error) {
                console.error("Error fetching zip code data:", error);
                manualLocationPromptEl.textContent = "Could not find that zip code. Please try another.";
                manualLocationPromptEl.classList.add('text-red-600');
            }
        }

        function locationSuccess(position) {
            const { latitude, longitude } = position.coords;
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const locationState = data.address.state_code ? data.address.state_code.toUpperCase() : null;
                    const scheduleKey = locationState && SCHEDULES[locationState] ? locationState : 'DEFAULT';
                    initApp(SCHEDULES[scheduleKey]);
                })
                .catch(error => {
                    console.error("Error fetching location data:", error);
                    locationError();
                });
        }

        function locationError() {
            console.warn("Geolocation failed or was denied.");
            loadingStateEl.classList.add('hidden');
            mainContentEl.classList.add('hidden'); // Keep main content hidden
            manualLocationFormEl.classList.remove('hidden');
        }
        
        window.onload = function() {
            // Add event listener for the manual form first
            manualSubmitBtn.addEventListener('click', handleManualZipSubmit);
            zipCodeInputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleManualZipSubmit();
                }
            });

            // Then, try to get the user's location
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(locationSuccess, locationError);
            } else {
                locationError();
            }
        };

    </script>
</body>
</html>
